{
    "id": "83926c12-8ac2-45cc-bef3-25d2f433d145",
    "scriptName": "åœ°å›¾æ˜¾ç¤ºå‰ç«¯-æ•°æ®åº“ç‰ˆ",
    "findRegex": "/$/g",
    "replaceString": "\n======å½“å‰åœ°å›¾=======\n\n```html\n<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no\">\n    <title>æ¸¸æˆä¸–ç•Œæ•°æ®é¢æ¿</title>\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\">\n    <link href=\"https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Kaiti&display=swap\" rel=\"stylesheet\">\n    <style>\n        :root {\n            --bg-main: #fdfaf5; /* ä»¿ç¾Šçš®çº¸èƒŒæ™¯è‰² */\n            --bg-container: rgba(245, 235, 220, 0.8); /* å®¹å™¨åŠé€æ˜èƒŒæ™¯ */\n            --text-main: #5a3e2b; /* ä¸»è¦æ–‡å­—é¢œè‰²ï¼Œæ·±æ£•è‰² */\n            --text-title: #3e271a; /* æ ‡é¢˜é¢œè‰²ï¼Œæ›´æ·±çš„æ£•è‰² */\n            --accent-color1: #8c6e54; /* ç‚¹ç¼€è‰²1ï¼Œç”¨äºæŒ‰é’®å’Œè¾¹æ¡† */\n            --accent-color2: #b48a5c; /* ç‚¹ç¼€è‰²2ï¼Œç”¨äºé«˜äº®å’Œäº¤äº’ */\n            --border-color: rgba(90, 62, 43, 0.3); /* è¾¹æ¡†é¢œè‰² */\n            --shadow-color: rgba(62, 39, 26, 0.2);\n            --font-title: 'Noto Serif SC', serif;\n            --font-main: 'Kaiti', 'Noto Serif SC', serif;\n            --radius-base: 8px;\n        }\n\n        body {\n            background-color: transparent;\n            margin: 0;\n            padding: 15px;\n            font-family: var(--font-main);\n            color: var(--text-main);\n            font-size: 17px; /* ç¨å¾®å¢å¤§åŸºç¡€å­—å· */\n            line-height: 1.6; /* æ”¹å–„è¡Œé—´è· */\n            background-image: url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAKAAoDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAT/xAAfEAACAQMFAQAAAAAAAAAAAAABAgMABBEhMQUSE0H/xAAUAQEAAAAAAAAAAAAAAAAAAAAF/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAMAwEAAhEDEQA/AJbGM2jlw2SOTbOQfowp4r24wLgYb6O2kLSyvIjdICQS7EAnHY1n6pQ//Z'); /* æ¨¡æ‹Ÿçº¸å¼ çº¹ç† */\n        }\n\n        .map-interface {\n            width: 100%;\n            margin: 0 auto;\n            background-color: var(--bg-main);\n            border: 1px solid var(--border-color); /* è¾¹æ¡†å˜ç»† */\n            border-radius: var(--radius-base);\n            padding: 20px;\n            box-sizing: border-box;\n            box-shadow: 0 4px 12px var(--shadow-color); /* é˜´å½±æ›´æŸ”å’Œ */\n            display: flex;\n            flex-direction: column;\n            gap: 10px; /* è¿›ä¸€æ­¥å‡å°ä¸»è¦æ¨¡å—é—´è· */\n        }\n\n        .top-bar {\n            display: flex;\n            justify-content: center; /* æ°´å¹³å±…ä¸­ */\n            text-align: center; /* æ–‡æœ¬å±…ä¸­ */\n            padding-bottom: 15px;\n            border-bottom: 1px solid var(--border-color);\n            flex-wrap: wrap;\n            gap: 10px;\n        }\n\n        .title-container h1 {\n            font-family: var(--font-title);\n            color: var(--text-title);\n            font-size: 2rem; /* å¢å¤§æ ‡é¢˜ */\n            margin: 0 0 5px 0; /* è°ƒæ•´å¤–è¾¹è· */\n            font-weight: 700;\n            text-shadow: 1px 1px 2px var(--shadow-color);\n        }\n        .current-time-container {\n            font-size: 0.95rem; /* åè°ƒå­—ä½“å¤§å° */\n            color: var(--text-main);\n            opacity: 0.9;\n            display: flex;\n            align-items: center;\n            justify-content: center; /* ç¡®ä¿å†…éƒ¨ä¹Ÿå±…ä¸­ */\n            gap: 8px;\n            white-space: nowrap;\n        }\n\n        /* ç§»é™¤æ—§çš„æŒ‰é’®å¯¼èˆªæ ï¼Œå› ä¸ºæŒ‰é’®å°†è¢«ç§»åˆ°æ–°çš„çŠ¶æ€æ ä¸­ */\n        .main-nav-buttons { display: none; }\n\n        /* --- æ–°å¢ï¼šä¸»è§’çŠ¶æ€æ  --- */\n        #protagonist-status-bar {\n            display: flex;\n            gap: 15px; /* å‡å°å¤´åƒå’Œä¿¡æ¯åŒºçš„é—´è· */\n            align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ */\n            padding: 10px; /* å‡å°å†…è¾¹è· */\n            background: var(--bg-container);\n            border: 1px solid var(--border-color);\n            border-radius: var(--radius-base);\n            margin: 0; /* ç§»é™¤å¤–è¾¹è· */\n            box-shadow: 0 2px 8px var(--shadow-color);\n        }\n        .protagonist-portrait {\n            width: 80px; /* ç¼©å°å¤´åƒå°ºå¯¸ */\n            height: 80px;\n            border-radius: var(--radius-base);\n            border: 2px solid var(--accent-color1);\n            overflow: hidden;\n            flex-shrink: 0;\n            cursor: pointer;\n            position: relative;\n            background-color: #e0d5c8;\n            box-shadow: 0 2px 6px rgba(0,0,0,0.15); /* æ·»åŠ è½»å¾®é˜´å½± */\n        }\n        .protagonist-portrait img {\n            width: 100%;\n            height: 100%;\n            object-fit: cover;\n        }\n         /* å¤´åƒä¸Šä¼ æç¤º */\n        .portrait-upload-prompt {\n            position: absolute;\n            bottom: 0;\n            left: 0;\n            right: 0;\n            background: rgba(0,0,0,0.6);\n            color: white;\n            text-align: center;\n            font-size: 12px;\n            padding: 4px 0;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n        .protagonist-portrait:hover .portrait-upload-prompt {\n            opacity: 1;\n        }\n        .protagonist-core-info {\n            flex-grow: 1;\n            display: flex;\n            flex-direction: row; /* æ°´å¹³æ’åˆ— */\n            justify-content: space-between; /* ä¸¤ç«¯å¯¹é½ */\n            align-items: center; /* æ”¹ä¸ºå‚ç›´å±…ä¸­ */\n            gap: 10px;\n        }\n        .protagonist-text-info {\n            display: flex;\n            flex-direction: column;\n            gap: 4px; /* æ–‡æœ¬ä¿¡æ¯å†…éƒ¨é—´è· */\n            align-items: flex-start; /* å·¦å¯¹é½ */\n        }\n        .protagonist-name-info {\n            display: flex;\n            flex-direction: column; /* å‚ç›´æ’åˆ—åå­—å’Œè¯¦æƒ… */\n            gap: 4px; /* åå­—å’Œè¯¦æƒ…çš„é—´è· */\n            align-items: flex-start; /* å·¦å¯¹é½ */\n        }\n        #protagonist-name {\n            font-family: var(--font-title);\n            font-size: 1.5rem; /* æ¢å¤ç¨å¤§çš„å­—å· */\n            color: var(--text-title);\n            font-weight: 700;\n            line-height: 1.2; /* è°ƒæ•´è¡Œé«˜ä½¿ä¹‹æ›´ç´§å‡‘ */\n        }\n        .protagonist-details {\n            display: flex;\n            flex-direction: column;\n            gap: 2px; /* è¡Œé—´è· */\n        }\n        .protagonist-details .detail-item {\n            font-size: 0.9rem;\n            opacity: 0.9;\n        }\n        .protagonist-money {\n            font-weight: bold;\n            color: var(--text-title);\n        }\n\n        .protagonist-main-controls {\n            display: flex;\n            gap: 8px; /* ç¼©å°æŒ‰é’®é—´è· */\n            flex-wrap: nowrap; /* ä¸æ¢è¡Œ */\n            align-items: center; /* å‚ç›´å±…ä¸­ */\n        }\n        .protagonist-stats-container {\n            flex-shrink: 0;\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            min-width: 120px; /* è°ƒæ•´å®½åº¦ */\n            padding-left: 10px; /* å‡å°å·¦è¾¹è· */\n            border-left: 1px solid var(--border-color); /* æ·»åŠ åˆ†å‰²çº¿ */\n        }\n        \n        .function-btn {\n            background: var(--bg-container);\n            border: 1px solid var(--border-color);\n            color: var(--text-title);\n            padding: 12px 20px; /* å¢å¤§æŒ‰é’®å†…è¾¹è· */\n            border-radius: var(--radius-base);\n            font-size: 1.1rem; /* å¢å¤§å­—ä½“ */\n            cursor: pointer;\n            transition: all 0.2s ease-in-out; /* è°ƒæ•´è¿‡æ¸¡æ•ˆæœ */\n            font-family: var(--font-title);\n            box-shadow: 0 2px 5px var(--shadow-color);\n            text-shadow: 1px 1px 1px rgba(255,255,255,0.2); /* å¢åŠ æ–‡å­—è´¨æ„Ÿ */\n        }\n        .function-btn:hover {\n            background-color: var(--accent-color1);\n            color: var(--bg-main);\n            box-shadow: 0 4px 8px var(--shadow-color);\n            transform: translateY(-2px);\n        }\n        .function-btn i { margin-right: 8px; }\n\n        .horizontal-scroll-list .function-btn {\n            flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®åœ¨flexå®¹å™¨ä¸­è¢«å‹ç¼© */\n            white-space: nowrap; /* é˜²æ­¢æŒ‰é’®å†…æ–‡å­—æ¢è¡Œ */\n        }\n\n        /* --- ä¸»è§’çŠ¶æ€æ åœ†å½¢æŒ‰é’®æ ·å¼ --- */\n        .protagonist-main-controls .function-btn {\n            width: 44px; /* å›ºå®šå®½åº¦ */\n            height: 44px; /* å›ºå®šé«˜åº¦ */\n            border-radius: 50%; /* åœ†å½¢ */\n            padding: 0; /* ç§»é™¤å†…è¾¹è· */\n            font-size: 1.2rem; /* è°ƒæ•´å›¾æ ‡å¤§å° */\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            flex-shrink: 0;\n        }\n        .protagonist-main-controls .function-btn span {\n            display: none; /* éšè—æ–‡å­— */\n        }\n        .protagonist-main-controls .function-btn i {\n            margin-right: 0; /* ç§»é™¤å›¾æ ‡çš„è¾¹è· */\n        }\n\n        .content-grid {\n            display: flex;\n            flex-wrap: wrap;\n            gap: 10px; /* å‡å°åœ°å›¾å’Œé‡è¦è§’è‰²æ çš„é—´è· */\n        }\n\n        /* Ensure grid items stack on mobile */\n        .grid-item {\n            flex-grow: 1;\n            min-width: 300px; /* Prevent items from becoming too small */\n        }\n        /* Fix for allowing horizontal scroll content inside a flex item */\n        #external-areas-section {\n            min-width: 0;\n        }\n\n        .grid-item {\n            background: var(--bg-container);\n            border: 1px solid var(--border-color);\n            border-radius: var(--radius-base);\n            padding: 25px; /* å¢åŠ å†…è¾¹è· */\n            box-shadow: 0 2px 8px var(--shadow-color);\n        }\n        \n        #protagonist-section { grid-column: 1 / -1; } /* ä¸»è§’éƒ¨åˆ†å æ»¡æ•´è¡Œ */\n\n        .section-title {\n            font-family: var(--font-title);\n            font-size: 1.4rem; /* å‡å°æ ‡é¢˜å­—å· */\n            color: var(--text-title);\n            margin-bottom: 15px;\n            padding-bottom: 10px;\n            border-bottom: 1px solid var(--border-color);\n            display: flex;\n            align-items: center;\n            font-weight: 700; /* åŠ ç²— */\n        }\n        .section-title i { \n            margin-right: 12px; \n            color: var(--accent-color1);\n            font-size: 1.1em; /* ç¨å¾®æ”¾å¤§å›¾æ ‡ */\n            vertical-align: -2px; /* è°ƒæ•´å›¾æ ‡å‚ç›´å¯¹é½ */\n        }\n        \n        /* Protagonist special UI */\n        .protagonist-layout { display: flex; gap: 20px; flex-wrap: wrap; }\n        .protagonist-info { flex: 2; min-width: 250px; }\n        .protagonist-stats { flex: 1; min-width: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center; }\n\n        .info-grid {\n            display: grid;\n            grid-template-columns: auto 1fr;\n            gap: 10px;\n            align-items: center;\n        }\n        .info-grid dt { font-weight: bold; color: var(--text-title); }\n        .info-grid dd { margin: 0; white-space: pre-wrap; }\n\n        .stats-hexagon {\n            position: relative;\n            width: 100px;\n            height: 115.5px; /* width * 0.866 */\n            margin: 0 auto;\n        }\n        .hexagon-shape {\n            position: absolute;\n            top: 0; left: 0;\n            width: 100%; height: 100%;\n            background-color: rgba(140, 110, 84, 0.1);\n            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);\n            border: 1px solid var(--border-color);\n        }\n        .stats-radar {\n            position: absolute;\n            top: 0; left: 0;\n            width: 100%; height: 100%;\n        }\n        .stat-label {\n            position: absolute;\n            font-size: 12px;\n            color: var(--text-title);\n            transform: translate(-50%, -50%);\n        }\n        \n        /* Key Characters List */\n        .character-card {\n            background: rgba(255, 255, 255, 0.5);\n            padding: 15px;\n            border-radius: var(--radius-base);\n            margin-bottom: 10px;\n            border-left: 5px solid var(--accent-color2);\n            cursor: pointer;\n            transition: all 0.2s ease;\n        }\n        .character-card:hover { transform: translateX(5px); background: rgba(255,255,255,0.8); }\n        .character-header { display: flex; justify-content: space-between; align-items: center; }\n        .character-name { font-family: var(--font-title); font-size: 1.2rem; color: var(--text-title); }\n        .character-status { font-size: 0.9rem; font-style: italic; }\n\n        /* Generic List Style for Skills, Inventory, etc. */\n        .item-list { list-style: none; padding: 0; margin: 0; }\n        .list-item {\n            padding: 12px 0;\n            border-bottom: 1px dashed var(--border-color);\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n        }\n        .list-item:last-child { border-bottom: none; }\n        .item-name { font-weight: bold; }\n        .item-details { font-size: 0.9rem; color: var(--text-main); }\n        \n        /* Quest Log Specific Styles */\n        #quest-items-container .list-item {\n            display: block;\n            padding: 0;\n            border-bottom: none;\n        }\n        #quest-items-container .list-item:last-child {\n            margin-bottom: 0;\n        }\n        .quest-item {\n            background-color: rgba(255, 255, 255, 0.4);\n            border: 1px solid var(--border-color);\n            border-left: 4px solid var(--accent-color2);\n            padding: 12px 15px;\n            margin-bottom: 10px;\n            border-radius: var(--radius-base);\n            transition: background-color 0.2s ease;\n        }\n        .quest-item:hover {\n            background-color: rgba(255, 255, 255, 0.7);\n        }\n        .quest-item .item-name {\n            font-family: var(--font-title);\n            font-size: 1.15rem;\n            margin-bottom: 8px;\n            color: var(--text-title);\n            font-weight: bold;\n        }\n        .quest-item .item-details {\n            font-size: 0.9rem;\n            margin-bottom: 4px;\n            padding-left: 5px;\n        }\n        .quest-item .item-details b {\n            color: var(--text-title);\n            margin-right: 5px;\n        }\n\n        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }\n        .modal-overlay.visible { opacity: 1; pointer-events: auto; }\n        .modal-dialog {\n            background: var(--bg-main);\n            border: 2px solid var(--accent-color1);\n            border-radius: var(--radius-base);\n            padding: 25px; /* è°ƒæ•´å†…è¾¹è· */\n            width: 90%;\n            max-width: 600px;\n            position: relative;\n            box-shadow: 0 5px 20px var(--shadow-color);\n            max-height: 85vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ */\n            display: flex;\n            flex-direction: column;\n        }\n        .modal-dialog h4 { font-family: var(--font-title); font-size: 1.6rem; color: var(--text-title); text-align: center; margin-top: 0; margin-bottom: 20px; }\n        .close-modal-button { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 28px; color: var(--accent-color1); cursor: pointer; transition: color 0.2s ease; }\n        .close-modal-button:hover { color: var(--text-title); }\n        .modal-content {\n            overflow-y: auto; /* å†…å®¹æº¢å‡ºæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */\n            flex-grow: 1;\n            padding-right: 15px;\n            word-wrap: break-word; /* å…è®¸é•¿å•è¯æˆ–URLæ¢è¡Œ */\n        }\n        .modal-content::-webkit-scrollbar { width: 6px; }\n        .modal-content::-webkit-scrollbar-track { background: var(--bg-container); }\n        .modal-content::-webkit-scrollbar-thumb { background: var(--accent-color1); border-radius: 3px; }\n\n        .interaction-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n            gap: 10px;\n            margin-top: 20px;\n            padding-top: 20px;\n            border-top: 1px solid var(--border-color);\n        }\n        /* ä»…é’ˆå¯¹è§’è‰²å¼¹çª—ï¼Œå¼ºåˆ¶2x2ç½‘æ ¼ */\n        #character-modal .interaction-grid {\n            grid-template-columns: repeat(2, 1fr);\n        }\n        .interaction-grid .function-btn {\n            width: 100%;\n            padding: 12px 10px; /* è°ƒæ•´å†…è¾¹è· */\n        }\n\n        .list-item-content {\n            flex-grow: 1;\n            margin-right: 10px;\n        }\n        .use-button {\n            background: var(--accent-color2);\n            color: white;\n            border: none;\n            padding: 5px 12px;\n            border-radius: var(--radius-base);\n            cursor: pointer;\n            font-size: 0.9rem;\n            margin-left: 15px;\n            flex-shrink: 0;\n            transition: background-color 0.2s;\n        }\n        .use-button:hover {\n            background: var(--accent-color1);\n        }\n\n        /* Map Styles */\n        #visual-map-container {\n            position: relative;\n            width: 100%;\n            border: 1px solid var(--border-color);\n            background-color: rgba(230, 220, 200, 0.5); /* A lighter parchment color */\n            border-radius: var(--radius-base);\n            overflow: hidden;\n            height: 60vh; /* å¢åŠ åœ°å›¾é«˜åº¦ */\n            flex-basis: 100%; /* Make map take full width */\n            box-shadow: inset 0 0 10px var(--shadow-color);\n        }\n        .map-controls { position: absolute; right: 10px; top: 10px; z-index: 10; display: flex; flex-direction: column; gap: 5px; }\n        .map-control-btn { background: var(--bg-container); border: 1px solid var(--border-color); color: var(--text-title); border-radius: 50%; cursor: pointer; width: 36px; height: 36px; line-height: 34px; text-align: center; font-size: 1rem; box-shadow: 0 1px 3px var(--shadow-color); }\n        #visual-map { display: block; width: 100%; height: 100%; cursor: grab; }\n        #visual-map:active { cursor: grabbing; }\n        .map-location-group { cursor: pointer; transition: all 0.2s ease; }\n        .map-location-rect { fill: rgba(140, 110, 84, 0.3); stroke: var(--accent-color1); stroke-width: 1.5px; }\n        .map-location-group:hover .map-location-rect { fill: rgba(180, 138, 92, 0.6); }\n        .map-location-label { fill: var(--text-title); text-anchor: middle; dominant-baseline: middle; pointer-events: none; user-select: none; font-size: 16px; font-weight: bold; font-family: var(--font-title); }\n\n        .protagonist-map-avatar {\n            pointer-events: none;\n        }\n        .protagonist-map-avatar .pulse-wave {\n            fill: none;\n            stroke: var(--accent-color2);\n            stroke-width: 2px;\n            transform-box: fill-box;\n            transform-origin: center;\n            animation: pulse-wave-animation 2s infinite cubic-bezier(0.445, 0.05, 0.55, 0.95);\n        }\n\n        @keyframes pulse-wave-animation {\n            0% {\n                transform: scale(1);\n                opacity: 1;\n            }\n            100% {\n                transform: scale(2.5);\n                opacity: 0;\n            }\n        }\n\n        .horizontal-scroll-list {\n            display: flex;\n            flex-wrap: nowrap;\n            gap: 12px; /* å¢åŠ æŒ‰é’®é—´è· */\n            overflow-x: auto;\n            padding: 5px 0 15px 0; /* è°ƒæ•´å†…è¾¹è· */\n            align-items: center;\n        }\n        .horizontal-scroll-list::-webkit-scrollbar { height: 6px; } /* åŠ ç²—æ»šåŠ¨æ¡ */\n        .horizontal-scroll-list::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }\n        .horizontal-scroll-list::-webkit-scrollbar-thumb { background: var(--accent-color1); border-radius: 2px; }\n\n        /* ç§»é™¤æ‰€æœ‰å®½å±æ ·å¼ */\n\n    @media (max-width: 768px) {\n        :root { --font-size-base: 12px; --spacing-md: 10px; --spacing-lg: 15px; }\n        body { padding: 5px; }\n        .map-interface { padding: var(--spacing-lg) var(--spacing-md); }\n        .map-header { flex-direction: column; gap: var(--spacing-md); }\n        .map-header h2 { font-size: 1.5rem; }\n        .top-right-buttons { order: -1; width: 100%; justify-content: center; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }\n        .top-right-buttons .partner-button { flex-grow: 1; justify-content: center; }\n        #visual-map-container { height: 38vh; min-height: 220px; }\n        .partner-button-list, .external-area-buttons { display: flex; flex-wrap: nowrap; overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; scrollbar-width: none; flex-shrink: 0; white-space: nowrap; }\n        .partner-button-list::-webkit-scrollbar, .external-area-buttons::-webkit-scrollbar { display: none; }\n        .partner-button { padding: 8px 14px; font-size: 0.9rem; flex-shrink: 0; white-space: nowrap; }\n        #important-character-buttons .partner-button { padding: 5px 10px 5px 5px; }\n        .sub-location-grid { grid-template-columns: 1fr; }\n        .modal-dialog { width: 95vw; padding: var(--spacing-lg) 15px; }\n        .modal-dialog h4 { font-size: 1.3rem; }\n        #modal-character-name { font-size: 1.7rem; }\n        .attributes-grid { grid-template-columns: repeat(2, 1fr); gap: var(--spacing-sm); }\n        .attribute-item { padding: var(--spacing-xs); }\n        .interaction-options-grid { grid-template-columns: 1fr; gap: var(--spacing-sm); }\n        .interaction-button, .sub-location-button { padding: 10px; font-size: 0.95rem; }\n        .shop-item, .inventory-item, .skill-item { flex-direction: column; align-items: center; gap: 10px; }\n        .shop-item > div, .inventory-item > div, .skill-item > div { text-align: center; }\n        .use-button { width: auto; padding-left: 40px; padding-right: 40px; }\n    }\n\n    @media (max-width: 480px) {\n        #protagonist-status-bar {\n            flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */\n            gap: 10px;\n            justify-content: center; /* å±…ä¸­å¤´åƒç­‰å…ƒç´  */\n        }\n\n        .protagonist-portrait {\n            width: 60px; /* è¿›ä¸€æ­¥ç¼©å°å¤´åƒ */\n            height: 60px;\n        }\n\n        .protagonist-stats-container {\n            padding-left: 0;\n            border-left: none; /* ç§»é™¤åˆ†å‰²çº¿ */\n            width: 100%; /* å æ»¡å¯ç”¨ç©ºé—´ä»¥å¸®åŠ©å±…ä¸­ */\n            min-height: 116px; /* ä¸ºåŸå§‹å°ºå¯¸çš„å…­è¾¹å½¢æä¾›è¶³å¤Ÿå‚ç›´ç©ºé—´ */\n            justify-content: center; /* æ°´å¹³å±…ä¸­ */\n            align-items: center; /* å‚ç›´å±…ä¸­ */\n        }\n\n        .stats-hexagon {\n            transform: scale(0.8); /* ç¼©å°æ•´ä¸ªå…­è¾¹å½¢ï¼ˆåŒ…æ‹¬æ ‡ç­¾å’Œç”»å¸ƒï¼‰ */\n            transform-origin: center center;\n        }\n\n        .protagonist-core-info {\n            flex-direction: column; /* æ”¹ä¸ºå‚ç›´æ’åˆ— */\n            align-items: stretch; /* æ‹‰ä¼¸ä»¥å¡«å……å®½åº¦ */\n            gap: 12px;\n            width: 100%; /* å æ»¡æ•´è¡Œå®½åº¦ */\n        }\n\n        .protagonist-text-info {\n            align-items: center; /* å±…ä¸­å¯¹é½æ–‡æœ¬ */\n            text-align: center;\n            width: 100%;\n        }\n        .protagonist-name-info, #protagonist-name {\n                align-items: center; /* ç¡®ä¿åå­—ä¹Ÿå±…ä¸­ */\n        }\n        #protagonist-name {\n            font-size: 1.3rem; /* è°ƒæ•´åå­—å¤§å° */\n        }\n\n        .protagonist-main-controls {\n            order: -1; /* å°†æŒ‰é’®æåˆ°æœ€å‰é¢ */\n            justify-content: center; /* å±…ä¸­æŒ‰é’® */\n            width: 100%;\n        }\n    }\n    </style>\n</head>\n<body>\n    <div class=\"map-interface\">\n        <!-- é¡¶éƒ¨ä¿¡æ¯ä¸å¯¼èˆªæ  -->\n        <header class=\"top-bar\">\n            <div class=\"title-container\">\n                <h1 id=\"map-title\">åœ°å›¾æ ‡é¢˜åŠ è½½ä¸­...</h1>\n                <div id=\"current-time-container\" class=\"current-time-container\">\n                    <i class=\"fas fa-clock\"></i>\n                    <span id=\"current-time\">----</span>\n                </div>\n            </div>\n        </header>\n\n        <!-- æ–°å¢ï¼šä¸»è§’çŠ¶æ€æ  -->\n        <section id=\"protagonist-status-bar\">\n            <div id=\"protagonist-portrait-container\" class=\"protagonist-portrait\" title=\"ç‚¹å‡»ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒ\">\n                <img id=\"protagonist-portrait-img\" src=\"\" alt=\"ä¸»è§’å¤´åƒ\">\n                <div class=\"portrait-upload-prompt\">æ›´æ¢å¤´åƒ</div>\n            </div>\n            <div class=\"protagonist-core-info\">\n                <div class=\"protagonist-text-info\">\n                    <div class=\"protagonist-name-info\">\n                        <h2 id=\"protagonist-name\" style=\"margin: 0;\"></h2>\n                        <div id=\"protagonist-details\" class=\"protagonist-details\"></div>\n                    </div>\n                    <div id=\"protagonist-money\" class=\"protagonist-money\"></div>\n                </div>\n                <div class=\"protagonist-main-controls\">\n                    <!-- è¯¦ç»†ä¿¡æ¯æŒ‰é’®å·²ç§»é™¤ï¼ŒåŠŸèƒ½æŒ‰é’®ä¿ç•™ -->\n                    <div class=\"function-btn\" id=\"skill-button\"><i class=\"fas fa-magic\"></i><span>æŠ€èƒ½</span></div>\n                    <div class=\"function-btn\" id=\"inventory-button\"><i class=\"fas fa-box-open\"></i><span>èƒŒåŒ…</span></div>\n                    <div class=\"function-btn\" id=\"quest-button\"><i class=\"fas fa-scroll\"></i><span>ä»»åŠ¡</span></div>\n                </div>\n            </div>\n            <div class=\"protagonist-stats-container\">\n                <div class=\"stats-hexagon\">\n                   <div class=\"hexagon-shape\"></div>\n                   <canvas id=\"main-stats-radar\" width=\"100\" height=\"115.5\"></canvas>\n                </div>\n            </div>\n        </section>\n\n\n        <!-- é‡è¦è§’è‰²æ  -->\n        <section id=\"key-characters-section\">\n            <div class=\"section-title\"><i class=\"fas fa-users\"></i>é‡è¦è§’è‰²</div>\n            <div id=\"character-bar\" class=\"horizontal-scroll-list\">\n                <!-- Character buttons will be inserted here by JS -->\n            </div>\n        </section>\n\n        <!-- ä¸»å†…å®¹åŒº -->\n        <main class=\"content-grid\" style=\"margin-top: 20px;\">\n            <!-- åœ°å›¾ -->\n            <section id=\"visual-map-container\">\n                <div class=\"map-controls\">\n                    <button id=\"zoom-in-btn\" class=\"map-control-btn\"><i class=\"fas fa-plus\"></i></button>\n                    <button id=\"zoom-out-btn\" class=\"map-control-btn\"><i class=\"fas fa-minus\"></i></button>\n                </div>\n                <svg id=\"visual-map\" preserveAspectRatio=\"xMidYMid meet\" xmlns=\"http://www.w3.org/2000/svg\"></svg>\n            </section>\n            \n            <!-- å¤–éƒ¨åŒºåŸŸ -->\n            <section id=\"external-areas-section\" class=\"grid-item\" style=\"grid-column: 1 / -1;\">\n                <div class=\"section-title\"><i class=\"fas fa-globe-americas\"></i>å¤–éƒ¨åŒºåŸŸ</div>\n                <div id=\"external-areas-list\" class=\"horizontal-scroll-list\"></div>\n            </section>\n            \n        </main>\n    </div>\n\n    <!-- å¼¹çª— -->\n    <div id=\"character-modal\" class=\"modal-overlay\"><div class=\"modal-dialog\"><button class=\"close-modal-button\">&times;</button><h4 id=\"modal-character-name\"></h4><div id=\"modal-character-content\" class=\"modal-content\"></div><div id=\"modal-character-interactions\" class=\"interaction-grid\"></div></div></div>\n    <div id=\"map-element-modal\" class=\"modal-overlay\"><div class=\"modal-dialog\"><button class=\"close-modal-button\">&times;</button><h4 id=\"modal-element-name\"></h4><div id=\"modal-element-description\" class=\"modal-content\"></div><div id=\"modal-element-interactions\" class=\"interaction-grid\"></div></div></div>\n    <!-- å…¶ä»–å¼¹çª— (æŠ€èƒ½ã€èƒŒåŒ…ç­‰) -->\n    <div id=\"skill-modal\" class=\"modal-overlay\"><div class=\"modal-dialog\"><button class=\"close-modal-button\">&times;</button><h4><i class=\"fas fa-magic\"></i> æŠ€èƒ½åˆ—è¡¨</h4><div id=\"skill-items-container\" class=\"modal-content\"></div></div></div>\n    <div id=\"inventory-modal\" class=\"modal-overlay\"><div class=\"modal-dialog\"><button class=\"close-modal-button\">&times;</button><h4><i class=\"fas fa-box-open\"></i> èƒŒåŒ…</h4><div id=\"inventory-items-container\" class=\"modal-content\"></div></div></div>\n    <div id=\"quest-modal\" class=\"modal-overlay\"><div class=\"modal-dialog\"><button class=\"close-modal-button\">&times;</button><h4><i class=\"fas fa-scroll\"></i> ä»»åŠ¡æ—¥å¿—</h4><div id=\"quest-items-container\" class=\"modal-content\"></div></div></div>\n    <div id=\"shop-modal\" class=\"modal-overlay\"><div class=\"modal-dialog\"><button class=\"close-modal-button\">&times;</button><h4><i class=\"fas fa-store\"></i> å•†åº—</h4><div id=\"shop-items-container\" class=\"modal-content\"></div></div></div>\n\n    <script>\n        document.addEventListener('DOMContentLoaded', function() {\n            // Use live data source from parent, or a fallback that returns nothing.\n            const dataSourceAPI = (typeof parent !== 'undefined' && parent.AutoCardUpdaterAPI) ? parent.AutoCardUpdaterAPI : {\n                exportTableAsJson: function() {\n                    console.log(\"No data source found.\");\n                    return {}; // Return empty object if no source\n                },\n                registerTableUpdateCallback: function(callback) {\n                    console.log(\"No data source found to register callback.\");\n                }\n            };\n\n            function getTableData() {\n                try {\n                    return dataSourceAPI.exportTableAsJson();\n                } catch (e) {\n                    console.error(\"Error getting table data:\", e);\n                    return {};\n                }\n            }\n\n            function processJsonData(json) {\n                const tables = {};\n                if (!json || typeof json !== 'object') {\n                    console.error(\"Invalid JSON data provided.\");\n                    return null;\n                }\n                for (const sheetId in json) {\n                    if (Object.prototype.hasOwnProperty.call(json, sheetId) && json[sheetId] && json[sheetId].name) {\n                        const sheet = json[sheetId];\n                        tables[sheet.name] = {\n                            headers: sheet.content[0] || [],\n                            rows: sheet.content.slice(1)\n                        };\n                    }\n                }\n                return tables;\n            }\n\n            function renderUI(tables) {\n                if (!tables) return;\n                \n                // --- 1. æ¸²æŸ“å…¨å±€æ•°æ® ---\n                const globalTable = tables[\"å…¨å±€æ•°æ®è¡¨\"];\n                const globalData = globalTable?.rows[0] || [];\n                const globalHeaders = globalTable?.headers || [];\n                \n                document.getElementById('map-title').textContent = globalData[globalHeaders.indexOf(\"åœ°å›¾æ ‡é¢˜\")] || 'æœªçŸ¥åŒºåŸŸ';\n                document.getElementById('current-time').textContent = `å½“å‰æ—¶é—´ï¼š${globalData[globalHeaders.indexOf(\"å½“å‰æ—¶é—´\")] || '----'}`;\n\n                // --- 2. æ¸²æŸ“ä¸»è§’çŠ¶æ€æ  ---\n                const pInfoTable = tables[\"ä¸»è§’ä¿¡æ¯\"];\n                const pInfoHeaders = pInfoTable?.headers || [];\n                const pInfo = pInfoTable?.rows[0] || [];\n\n                // åŠ è½½ä¸»è§’å¤´åƒï¼ˆä¼˜å…ˆä»æœ¬åœ°å­˜å‚¨åŠ è½½ï¼‰\n                loadProtagonistAvatar('', 'ä¸»è§’');\n\n                if (pInfo.length > 0) {\n                    // åŸºæœ¬ä¿¡æ¯\n                    document.getElementById('protagonist-name').textContent = pInfo[pInfoHeaders.indexOf(\"äººç‰©åç§°\")] || 'ä¸»è§’';\n                    const detailsContainer = document.getElementById('protagonist-details');\n                    detailsContainer.innerHTML = `\n                        <div class=\"detail-item\">${pInfo[pInfoHeaders.indexOf(\"æ€§åˆ«/å¹´é¾„\")] || 'æœªçŸ¥'}</div>\n                        <div class=\"detail-item\">${pInfo[pInfoHeaders.indexOf(\"èŒä¸š/èº«ä»½\")] || 'æœªçŸ¥'}</div>\n                    `;\n                    // ç§»é™¤é‡‘é’±å’Œé›·è¾¾å›¾çš„æ˜¾ç¤º\n                    document.getElementById('protagonist-money').textContent = '';\n                    const statsContainer = document.querySelector('.protagonist-stats-container');\n                    if(statsContainer) statsContainer.style.display = 'none';\n                }\n                \n                // --- 3. æ¸²æŸ“é‡è¦äººç‰©æŒ‰é’® (åŒ…æ‹¬ä¸»è§’) ---\n                const characterBar = document.getElementById('character-bar');\n                characterBar.innerHTML = '';\n\n                // é¦–å…ˆæ·»åŠ ä¸»è§’æŒ‰é’®\n                if (pInfo.length > 0) {\n                     const pBtn = document.createElement('button');\n                     pBtn.className = 'function-btn';\n                     pBtn.innerHTML = `<i class=\"fas fa-user-circle\"></i> ${pInfo[pInfoHeaders.indexOf(\"äººç‰©åç§°\")] || 'ä¸»è§’'}`;\n                     pBtn.onclick = () => openCharacterModal({\n                         isProtagonist: true,\n                         info: pInfo, infoHeaders: pInfoHeaders\n                     });\n                     characterBar.appendChild(pBtn);\n                }\n\n                const characters = tables[\"é‡è¦äººç‰©è¡¨\"]?.rows || [];\n                const charHeaders = tables[\"é‡è¦äººç‰©è¡¨\"]?.headers || [];\n                const protagonistName = pInfo[pInfoHeaders.indexOf(\"äººç‰©åç§°\")];\n                characters.forEach(charData => {\n                    const charName = charData[charHeaders.indexOf('å§“å')];\n                    // è¿‡æ»¤æ‰ä¸»è§’æœ¬äººï¼Œå› ä¸ºå·²åœ¨ä¸Šé¢ç‹¬ç«‹æ·»åŠ \n                    if (charName && charName !== protagonistName) {\n                        const isDeparted = charData[charHeaders.indexOf('æ˜¯å¦ç¦»åœº')] === 'æ˜¯';\n                        const charBtn = document.createElement('button');\n                        charBtn.className = 'function-btn';\n                        charBtn.innerHTML = `<i class=\"fas fa-id-badge\"></i> ${charName}`;\n                        charBtn.onclick = () => openCharacterModal({ info: charData, infoHeaders: charHeaders });\n                        if (isDeparted) {\n                            charBtn.style.display = 'none';\n                        }\n                        characterBar.appendChild(charBtn);\n                    }\n                });\n\n                // --- 4. è®¾ç½®å¼¹çª—å†…å®¹ ---\n                setupModalContent('skill-modal', 'skill-items-container', tables[\"ä¸»è§’æŠ€èƒ½è¡¨\"], (item, headers) => {\n                    const listItem = document.createElement('li');\n                    listItem.className = 'list-item';\n                    \n                    const content = document.createElement('div');\n                    content.className = 'list-item-content';\n                    const skillName = item[headers.indexOf('æŠ€èƒ½åç§°')];\n                    content.innerHTML = `\n                        <div class=\"item-name\">${skillName} <small>[${item[headers.indexOf('ç­‰çº§/é˜¶æ®µ')]}]</small></div>\n                        <div class=\"item-details\">${item[headers.indexOf('æ•ˆæœæè¿°')]}</div>\n                    `;\n\n                    const useButton = document.createElement('button');\n                    useButton.className = 'use-button';\n                    useButton.textContent = 'ä½¿ç”¨';\n                    useButton.onclick = () => sendGameActionRequest(`ä½¿ç”¨æŠ€èƒ½ ${skillName}`);\n                    \n                    listItem.appendChild(content);\n                    listItem.appendChild(useButton);\n                    return listItem;\n                });\n                setupModalContent('inventory-modal', 'inventory-items-container', tables[\"èƒŒåŒ…ç‰©å“è¡¨\"], (item, headers) => {\n                    const listItem = document.createElement('li');\n                    listItem.className = 'list-item';\n\n                    const content = document.createElement('div');\n                    content.className = 'list-item-content';\n                    const itemName = item[headers.indexOf('ç‰©å“åç§°')];\n                    content.innerHTML = `\n                        <div class=\"item-name\">${itemName} (x${item[headers.indexOf('æ•°é‡')]})</div>\n                        <div class=\"item-details\">${item[headers.indexOf('æè¿°/æ•ˆæœ')]}</div>\n                    `;\n\n                    const useButton = document.createElement('button');\n                    useButton.className = 'use-button';\n                    useButton.textContent = 'ä½¿ç”¨';\n                    useButton.onclick = () => sendGameActionRequest(`ä½¿ç”¨ç‰©å“ ${itemName}`);\n\n                    listItem.appendChild(content);\n                    listItem.appendChild(useButton);\n                    return listItem;\n                });\n                setupModalContent('quest-modal', 'quest-items-container', tables[\"ä»»åŠ¡ä¸äº‹ä»¶è¡¨\"], (item, headers) => {\n                    const listItem = document.createElement('li');\n                    listItem.className = 'list-item';\n                    listItem.innerHTML = `\n                        <div class=\"quest-item\">\n                            <div class=\"item-name\">${item[headers.indexOf('ä»»åŠ¡åç§°')]} <small>[${item[headers.indexOf('ä»»åŠ¡ç±»å‹')]}]</small></div>\n                            <div class=\"item-details\"><b>å‘å¸ƒè€…:</b> ${item[headers.indexOf('å‘å¸ƒè€…')]}</div>\n                            <div class=\"item-details\"><b>æè¿°:</b> ${item[headers.indexOf('è¯¦ç»†æè¿°')]}</div>\n                            <div class=\"item-details\"><b>è¿›åº¦:</b> ${item[headers.indexOf('å½“å‰è¿›åº¦')]}</div>\n                        </div>\n                    `;\n                    return listItem;\n                });\n\n                // Render Map and External Areas\n                const locations = [];\n                const mainLocTable = tables[\"ä¸»è¦åœ°ç‚¹è¡¨\"];\n                const elementsTable = tables[\"åœ°å›¾å…ƒç´ è¡¨\"];\n                const elementsByLocation = {};\n\n                if (elementsTable?.rows) {\n                    elementsTable.rows.forEach(elRow => {\n                        const locName = elRow[elementsTable.headers.indexOf('æ‰€å±ä¸»åœ°ç‚¹')];\n                        if (!locName) return;\n                        if (!elementsByLocation[locName]) elementsByLocation[locName] = [];\n                        elementsByLocation[locName].push({\n                            name: elRow[elementsTable.headers.indexOf('å…ƒç´ åç§°')],\n                            type: elRow[elementsTable.headers.indexOf('å…ƒç´ ç±»å‹')],\n                            description: elRow[elementsTable.headers.indexOf('å…ƒç´ æè¿°')],\n                            status: elRow[elementsTable.headers.indexOf('çŠ¶æ€')],\n                            interactions: [\n                                elRow[elementsTable.headers.indexOf('äº’åŠ¨é€‰é¡¹1')],\n                                elRow[elementsTable.headers.indexOf('äº’åŠ¨é€‰é¡¹2')],\n                                elRow[elementsTable.headers.indexOf('äº’åŠ¨é€‰é¡¹3')]\n                            ].filter(Boolean)\n                        });\n                    });\n                }\n\n                if (mainLocTable?.rows) {\n                    mainLocTable.rows.forEach(locRow => {\n                        const name = locRow[mainLocTable.headers.indexOf('åœ°ç‚¹åç§°')];\n                        const x = parseInt(locRow[mainLocTable.headers.indexOf('Xåæ ‡')]);\n                        const y = parseInt(locRow[mainLocTable.headers.indexOf('Yåæ ‡')]);\n                        const width = parseInt(locRow[mainLocTable.headers.indexOf('å®½åº¦')]);\n                        const height = parseInt(locRow[mainLocTable.headers.indexOf('é«˜åº¦')]);\n                        if (name && !isNaN(x) && !isNaN(y) && !isNaN(width) && !isNaN(height)) {\n                            locations.push({\n                                name, x, y, width, height,\n                                description: locRow[mainLocTable.headers.indexOf('ç¯å¢ƒæè¿°')],\n                                elements: elementsByLocation[name] || []\n                            });\n                        }\n                    });\n                }\n                \n                // ä»ä¸»è§’ä¿¡æ¯è¡¨è·å–ä¸»è§’å½“å‰ä½ç½®\n                const protagonistLocation = pInfo[pInfoHeaders.indexOf(\"ä¸»è§’å½“å‰æ‰€åœ¨åœ°ç‚¹\")];\n                renderMap(locations, protagonistLocation);\n                \n                const externalAreas = (globalData[globalHeaders.indexOf(\"å¤–éƒ¨åŒºåŸŸåˆ—è¡¨\")] || '').split(/[,ï¼Œï¼›;]/).map(s => s.trim()).filter(Boolean);\n                renderExternalAreas(externalAreas);\n            }\n\n            /**\n             * å½“å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶ï¼Œåº”ç”¨ä¸€ä¸ªå¤‡ç”¨UIï¼ˆå½©è‰²èƒŒæ™¯åŠ é—®å·ï¼‰ã€‚\n             * @param {HTMLElement} element - å›¾ç‰‡çš„å®¹å™¨å…ƒç´ ã€‚\n             */\n            function applyImageFallback(element) {\n                if (!element) return;\n                const colors = ['#5a5a5a', '#6a4c4c', '#4c6a4c', '#4c4c6a', '#6a6a4c', '#4c6a6a'];\n                const randomColor = colors[Math.floor(Math.random() * colors.length)];\n                \n                element.innerHTML = ''; // æ¸…é™¤æŸåçš„imgæ ‡ç­¾\n                element.style.backgroundImage = 'none';\n                element.style.backgroundColor = randomColor;\n                element.style.display = 'flex';\n                element.style.justifyContent = 'center';\n                element.style.alignItems = 'center';\n                element.style.color = '#fff';\n                const size = Math.min(element.offsetWidth, element.offsetHeight);\n                element.style.fontSize = `${size * 0.6}px`;\n                element.style.fontWeight = 'bold';\n                element.style.lineHeight = '1';\n                element.textContent = '?';\n            }\n\n            /**\n             * ä»å¤šä¸ªæ¥æºåŠ è½½ä¸»è§’å¤´åƒï¼Œå¹¶æä¾›å¼ºå¤§çš„å›é€€æœºåˆ¶ã€‚\n             * @param {string} avatarUrlFromData - ä»æ•°æ®æºè·å–çš„å¤´åƒURLã€‚\n             * @param {string} protagonistName - ä¸»è§’åå­—ï¼Œç”¨äºlocalStorageçš„é”®ã€‚\n             */\n            function loadProtagonistAvatar(avatarUrlFromData, protagonistName) {\n                const container = document.getElementById('protagonist-portrait-container');\n                const imgElement = document.getElementById('protagonist-portrait-img');\n                const customAvatarKey = 'protagonist-custom-avatar-ä¸»è§’';\n                const customAvatar = localStorage.getItem(customAvatarKey);\n                const defaultAvatar = \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸ‘¤%3C/text%3E%3C/svg%3E\";\n\n                // æ¸…ç†æ—§çš„UIå…ƒç´ ï¼ˆå¦‚å›¾æ ‡å’Œé‡ç½®æŒ‰é’®ï¼‰\n                const existingResetBtn = container.querySelector('.avatar-reset-btn');\n                if (existingResetBtn) existingResetBtn.remove();\n                \n                // ç¡®ä¿å›¾ç‰‡å’Œå®¹å™¨æ¢å¤æ­£å¸¸æ ·å¼\n                imgElement.style.display = 'block';\n                container.style.backgroundColor = '#e0d5c8';\n                // å¦‚æœå®¹å™¨é‡Œæœ‰æ–‡å­—ï¼ˆæ¯”å¦‚fallbackçš„é—®å·ï¼‰ï¼Œå…ˆæ¸…ç©º\n                if(container.textContent) container.textContent = '';\n                // ç¡®ä¿å›¾ç‰‡å…ƒç´ åœ¨å®¹å™¨é‡Œ\n                if(!container.contains(imgElement)) container.appendChild(imgElement);\n\n\n\n                const sources = [];\n                if (customAvatar) sources.push(customAvatar);\n                if (avatarUrlFromData && (avatarUrlFromData.startsWith('http') || avatarUrlFromData.startsWith('data:'))) {\n                    sources.push(avatarUrlFromData);\n                }\n                sources.push(defaultAvatar);\n\n                let sourceIndex = 0;\n                const tryNextSource = () => {\n                    if (sourceIndex >= sources.length) {\n                        applyImageFallback(container);\n                        return;\n                    }\n                    imgElement.src = sources[sourceIndex];\n                    sourceIndex++;\n                };\n\n                imgElement.onerror = tryNextSource;\n                tryNextSource();\n            }\n\n            document.getElementById('protagonist-portrait-container').addEventListener('click', () => {\n                const customAvatarKey = 'protagonist-custom-avatar-ä¸»è§’';\n\n                const input = document.createElement('input');\n                input.type = 'file';\n                input.accept = \"image/*\";\n                input.onchange = (event) => {\n                    const file = event.target.files[0];\n                    if (!file) return;\n\n                    const reader = new FileReader();\n                    reader.onload = (e) => {\n                        const img = new Image();\n                        img.onload = () => {\n                            const canvas = document.createElement('canvas');\n                            const ctx = canvas.getContext('2d');\n                            const TARGET_SIZE = 300;\n                            canvas.width = TARGET_SIZE;\n                            canvas.height = TARGET_SIZE;\n                            \n                            // è£å‰ªä¸ºæ­£æ–¹å½¢\n                            const size = Math.min(img.width, img.height);\n                            const x = (img.width - size) / 2;\n                            const y = (img.height - size) / 2;\n                            \n                            ctx.drawImage(img, x, y, size, size, 0, 0, TARGET_SIZE, TARGET_SIZE);\n\n                            const dataUrl = canvas.toDataURL('image/png');\n\n                            try {\n                                localStorage.setItem(customAvatarKey, dataUrl);\n                                const imgElement = document.getElementById('protagonist-portrait-img');\n                                imgElement.src = dataUrl;\n                            } catch (err) {\n                                console.error(\"ä¿å­˜è‡ªå®šä¹‰å¤´åƒå¤±è´¥:\", err);\n                                alert('å›¾ç‰‡å¤ªå¤§æˆ–æµè§ˆå™¨ç¼“å­˜å·²æ»¡ï¼Œæ— æ³•ä¿å­˜ã€‚è¯·å°è¯•æ¸…ç†æµè§ˆå™¨ç¼“å­˜æˆ–ä½¿ç”¨æ›´å°çš„å›¾ç‰‡ã€‚');\n                            }\n                        };\n                        img.src = e.target.result;\n                    };\n                    reader.readAsDataURL(file);\n                };\n                input.click();\n            });\n            \n            function drawRadarChart(stats, canvasId) {\n                const canvas = document.getElementById(canvasId);\n                if (!canvas || !canvas.getContext) return;\n\n                const ctx = canvas.getContext('2d');\n                const width = canvas.width;\n                const height = canvas.height;\n                const centerX = width / 2;\n                const centerY = height / 2;\n                const radius = width / 2 - 20; // ç•™å‡ºæ ‡ç­¾ç©ºé—´\n                \n                const labels = [\"åŠ›é‡\", \"æ•æ·\", \"ä½“è´¨\", \"æ™ºåŠ›\", \"æ„ŸçŸ¥\", \"é­…åŠ›\"];\n                // ç¡®ä¿å³ä½¿æ•°æ®ä¸å…¨ï¼Œä¹ŸæŒ‰å›ºå®šé¡ºåºå’Œæ•°é‡æ¸²æŸ“\n                const values = labels.map(label => stats[label] || 0);\n                const numStats = labels.length;\n                if (numStats === 0) return;\n\n                ctx.clearRect(0, 0, width, height);\n\n                // Draw radar shape\n                ctx.beginPath();\n                for (let i = 0; i < numStats; i++) {\n                    const angle = (Math.PI * 2 / numStats) * i - Math.PI / 2;\n                    const value = Math.max(0, Math.min(30, values[i])) / 30; // Normalize to 0-1, max value 30 for scale\n                    const x = centerX + radius * value * Math.cos(angle);\n                    const y = centerY + radius * value * Math.sin(angle);\n                    if (i === 0) {\n                        ctx.moveTo(x, y);\n                    } else {\n                        ctx.lineTo(x, y);\n                    }\n                }\n                ctx.closePath();\n                ctx.fillStyle = 'rgba(180, 138, 92, 0.5)';\n                ctx.fill();\n                ctx.strokeStyle = 'rgba(62, 39, 26, 0.8)';\n                ctx.stroke();\n                \n                // Draw labels\n                const labelContainer = canvas.parentElement;\n                // Clear previous labels\n                labelContainer.querySelectorAll('.stat-label').forEach(el => el.remove());\n                \n                labels.forEach((label, i) => {\n                    const angle = (Math.PI * 2 / numStats) * i - Math.PI / 2;\n                    const labelRadius = radius + 10;\n                    const x = centerX + labelRadius * Math.cos(angle);\n                    const y = centerY + labelRadius * Math.sin(angle);\n                    \n                    const labelEl = document.createElement('div');\n                    labelEl.className = 'stat-label';\n                    labelEl.textContent = label.charAt(0);\n                    labelEl.style.left = `${x}px`;\n                    labelEl.style.top = `${y}px`;\n                    labelContainer.appendChild(labelEl);\n                });\n            }\n\n            function openModal(modalId) { document.getElementById(modalId).classList.add('visible'); }\n            function closeModal(modalId) { document.getElementById(modalId).classList.remove('visible'); }\n\n            /**\n             * æ£€æŸ¥ä¸¤ä¸ªçŸ©å½¢æ˜¯å¦é‡å ï¼ˆå¸¦è¾¹è·ï¼‰ã€‚\n             * @param {object} rect1 - {x, y, width, height}\n             * @param {object} rect2 - {x, y, width, height}\n             * @returns {boolean} - å¦‚æœé‡å åˆ™è¿”å› trueã€‚\n             */\n            function checkOverlap(rect1, rect2) {\n                var margin = 10; // å¢åŠ è¾¹è·é˜²æ­¢æ ‡ç­¾æ¥è§¦\n                return (rect1.x < rect2.x + rect2.width + margin &&\n                        rect1.x + rect1.width + margin > rect2.x &&\n                        rect1.y < rect2.y + rect2.height + margin &&\n                        rect1.y + rect1.height + margin > rect2.y);\n            }\n\n            /**\n             * ä½¿ç”¨ç®€å•çš„åŠ›å¯¼å‘ç®—æ³•è°ƒæ•´å¸ƒå±€ï¼Œä»¥æœ€å°åŒ–é‡å ã€‚\n             * @param {Array<object>} locations - åœ°ç‚¹å¯¹è±¡æ•°ç»„ã€‚\n             * @returns {Array<object>} - ä¿®æ”¹åçš„åœ°ç‚¹å¯¹è±¡æ•°ç»„ã€‚\n             */\n            function adjustLayoutForOverlaps(locations) {\n                if (!locations || locations.length < 2) return locations;\n                var iterations = 150, forceFactor = 0.5;\n                for (var i = 0; i < iterations; i++) {\n                    for (var j = 0; j < locations.length; j++) {\n                        for (var k = j + 1; k < locations.length; k++) {\n                            var locA = locations[j], locB = locations[k];\n                            if (checkOverlap(locA, locB)) {\n                                var dx = (locA.x + locA.width / 2) - (locB.x + locB.width / 2);\n                                var dy = (locA.y + locA.height / 2) - (locB.y + locB.height / 2);\n                                var distance = Math.sqrt(dx * dx + dy * dy);\n                                if (distance === 0) { // é˜²æ­¢é™¤é›¶\n                                    dx = (Math.random() - 0.5) * 0.1;\n                                    dy = (Math.random() - 0.5) * 0.1;\n                                    distance = Math.sqrt(dx * dx + dy * dy);\n                                }\n                                var overlapX = (locA.width / 2 + locB.width / 2) - Math.abs(dx);\n                                var overlapY = (locA.height / 2 + locB.height / 2) - Math.abs(dy);\n                                if (overlapX > 0 && overlapY > 0) {\n                                    var moveX = (dx / distance) * overlapX * forceFactor;\n                                    var moveY = (dy / distance) * overlapY * forceFactor;\n                                    locA.x += moveX; locA.y += moveY;\n                                    locB.x -= moveX; locB.y -= moveY;\n                                }\n                            }\n                        }\n                    }\n                }\n                return locations;\n            }\n\n            function renderMap(locations, protagonistLocation) {\n                // åœ¨æ¸²æŸ“å‰è°ƒæ•´å¸ƒå±€ä»¥é¿å…é‡å \n                if (locations && locations.length > 0) {\n                    locations = adjustLayoutForOverlaps(locations);\n                }\n                const svg = document.getElementById('visual-map');\n                svg.innerHTML = '';\n                if (!locations || locations.length === 0) {\n                    svg.setAttribute('viewBox', '0 0 800 600');\n                    const text = document.createElementNS(\"http://www.w3.org/2000/svg\", 'text');\n                    text.setAttribute('x', '400');\n                    text.setAttribute('y', '300');\n                    text.setAttribute('class', 'map-location-label');\n                    text.textContent = 'æš‚æ— åœ°å›¾æ•°æ®';\n                    svg.appendChild(text);\n                    return;\n                }\n                \n                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;\n                locations.forEach(l => {\n                    minX = Math.min(minX, l.x);\n                    minY = Math.min(minY, l.y);\n                    maxX = Math.max(maxX, l.x + l.width);\n                    maxY = Math.max(maxY, l.y + l.height);\n                });\n\n                const padding = Math.max((maxX - minX) * 0.1, (maxY - minY) * 0.1, 50);\n                const vbX = minX - padding, vbY = minY - padding;\n                const vbW = (maxX - minX) + (padding * 2);\n                const vbH = (maxY - minY) + (padding * 2);\n                svg.setAttribute('viewBox', `${vbX} ${vbY} ${vbW} ${vbH}`);\n\n                locations.forEach(loc => {\n                    const g = document.createElementNS(\"http://www.w3.org/2000/svg\", 'g');\n                    g.setAttribute('class', 'map-location-group');\n                    g.addEventListener('click', () => openLocationModal(loc));\n\n                    const r = document.createElementNS(\"http://www.w3.org/2000/svg\", 'rect');\n                    r.setAttribute('x', loc.x);\n                    r.setAttribute('y', loc.y);\n                    r.setAttribute('width', loc.width);\n                    r.setAttribute('height', loc.height);\n                    r.setAttribute('class', 'map-location-rect');\n                    r.setAttribute('rx', '8'); // Rounded corners to match theme\n\n                    const t = document.createElementNS(\"http://www.w3.org/2000/svg\", 'text');\n                    t.setAttribute('x', loc.x + loc.width / 2);\n                    t.setAttribute('y', loc.y + loc.height / 2);\n                    t.setAttribute('class', 'map-location-label');\n                    t.textContent = loc.name;\n                    \n                    g.appendChild(r);\n                    g.appendChild(t);\n                    svg.appendChild(g);\n\n                    // å¦‚æœæ˜¯ä¸»è§’æ‰€åœ¨ä½ç½®ï¼Œæ·»åŠ å¤´åƒæ ‡è®°\n                    if (loc.name === protagonistLocation) {\n                        const protagonistImgSrc = document.getElementById('protagonist-portrait-img').src;\n                        const avatarGroup = document.createElementNS(\"http://www.w3.org/2000/svg\", 'g');\n                        avatarGroup.setAttribute('class', 'protagonist-map-avatar');\n                        \n                        // åˆ›å»ºå¤–å›´çš„è„‰å†²æ³¢circle\n                        const pulseCircle = document.createElementNS(\"http://www.w3.org/2000/svg\", 'circle');\n                        pulseCircle.setAttribute('cx', loc.x + loc.width / 2);\n                        pulseCircle.setAttribute('cy', loc.y + loc.height / 2);\n                        pulseCircle.setAttribute('r', '12'); // åˆå§‹åŠå¾„\n                        pulseCircle.setAttribute('class', 'pulse-wave');\n\n                        // åˆ›å»ºç”¨ä½œå¤´åƒçš„imageå…ƒç´ \n                        const avatarImage = document.createElementNS(\"http://www.w3.org/2000/svg\", 'image');\n                        avatarImage.setAttribute('x', loc.x + loc.width / 2 - 12);\n                        avatarImage.setAttribute('y', loc.y + loc.height / 2 - 12);\n                        avatarImage.setAttribute('width', '24');\n                        avatarImage.setAttribute('height', '24');\n                        avatarImage.setAttribute('href', protagonistImgSrc);\n                        \n                        // åˆ›å»ºä¸€ä¸ªåœ†å½¢å‰ªè£è’™ç‰ˆ\n                        const clipPath = document.createElementNS('http://www.w3.org/2000/svg', 'clipPath');\n                        const clipPathId = 'avatar-clip-path';\n                        clipPath.setAttribute('id', clipPathId);\n                        const clipCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');\n                        clipCircle.setAttribute('cx', loc.x + loc.width / 2);\n                        clipCircle.setAttribute('cy', loc.y + loc.height / 2);\n                        clipCircle.setAttribute('r', '12');\n                        clipPath.appendChild(clipCircle);\n                        \n                        avatarImage.setAttribute('clip-path', `url(#${clipPathId})`);\n\n                        avatarGroup.appendChild(clipPath);\n                        avatarGroup.appendChild(pulseCircle);\n                        avatarGroup.appendChild(avatarImage);\n                        svg.appendChild(avatarGroup);\n                    }\n                });\n            }\n\n            function renderExternalAreas(areas) {\n                const container = document.getElementById('external-areas-list');\n                container.innerHTML = '';\n                if (!areas || areas.length === 0) {\n                    container.innerHTML = `<p style=\"opacity: 0.7;\">æ— å…¶ä»–å¯æ¢ç´¢åŒºåŸŸ</p>`;\n                    return;\n                }\n                areas.forEach(area => {\n                    const btn = document.createElement('button');\n                    btn.className = 'function-btn';\n                    btn.innerHTML = `<i class=\"fas fa-map-signs\"></i> ${area}`;\n                    btn.onclick = () => sendGameActionRequest(`å‰å¾€ ${area}`);\n                    container.appendChild(btn);\n                });\n            }\n\n            function openLocationModal(loc) {\n                const modal = document.getElementById('map-element-modal');\n                modal.querySelector('#modal-element-name').textContent = loc.name;\n                \n                const contentContainer = modal.querySelector('#modal-element-description');\n                contentContainer.innerHTML = `<p>${loc.description || 'æš‚æ— æè¿°'}</p>`;\n                \n                const interactionsContainer = modal.querySelector('#modal-element-interactions');\n                interactionsContainer.innerHTML = '';\n                // Use flex to center the single button\n                interactionsContainer.style.display = 'flex';\n                interactionsContainer.style.justifyContent = 'center';\n\n                if (loc.elements && loc.elements.length > 0) {\n                    contentContainer.innerHTML += `<h5 style=\"margin-top: 20px; margin-bottom: 10px; font-family: var(--font-title); color: var(--text-title);\">å¯äº’åŠ¨å…ƒç´ :</h5>`;\n                    loc.elements.forEach(el => {\n                        const elBtn = document.createElement('button');\n                        elBtn.className = 'function-btn';\n                        elBtn.style.width = '100%';\n                        elBtn.style.marginBottom = '5px';\n                        elBtn.style.textAlign = 'left';\n                        elBtn.textContent = `${el.name} (${el.status})`;\n                        elBtn.onclick = (e) => {\n                            e.stopPropagation(); // Prevent modal from closing\n                            openMapElementModal(el);\n                        };\n                        contentContainer.appendChild(elBtn);\n                    });\n                }\n\n                const goHereBtn = document.createElement('button');\n                goHereBtn.className = 'function-btn';\n                goHereBtn.style.width = 'auto'; // Override full-width grid style\n                goHereBtn.innerHTML = `<i class=\"fas fa-shoe-prints\"></i> åˆ°è¿™é‡Œå»`;\n                goHereBtn.onclick = () => {\n                    sendGameActionRequest(`å‰å¾€ ${loc.name}`);\n                    closeModal('map-element-modal');\n                };\n                interactionsContainer.appendChild(goHereBtn);\n                \n                openModal('map-element-modal');\n            }\n\n            function openMapElementModal(el) {\n                 const modal = document.getElementById('map-element-modal');\n                 modal.querySelector('#modal-element-name').textContent = el.name;\n                 modal.querySelector('#modal-element-description').innerHTML = `<p>${el.description}</p><p><b>çŠ¶æ€:</b> ${el.status}</p>`;\n\n                 const interactionsContainer = modal.querySelector('#modal-element-interactions');\n                 interactionsContainer.innerHTML = '';\n                 // Reset container style to default grid for multiple buttons\n                 interactionsContainer.style.display = '';\n                 interactionsContainer.style.justifyContent = '';\n                 el.interactions.forEach(action => {\n                     const btn = document.createElement('button');\n                     btn.className = 'function-btn';\n                     btn.textContent = action;\n                     btn.onclick = () => {\n                         sendGameActionRequest(action);\n                         closeModal('map-element-modal');\n                     };\n                     interactionsContainer.appendChild(btn);\n                 });\n                 openModal('map-element-modal');\n            }\n\n            function openCharacterModal(character) {\n                const modal = document.getElementById('character-modal');\n                const nameEl = document.getElementById('modal-character-name');\n                const contentContainer = document.getElementById('modal-character-content');\n                const interactionsContainer = document.getElementById('modal-character-interactions');\n                \n                contentContainer.innerHTML = '';\n                interactionsContainer.innerHTML = '';\n                nameEl.textContent = character.info[character.infoHeaders.indexOf(character.isProtagonist ? \"äººç‰©åç§°\" : \"å§“å\")] || 'æœªçŸ¥';\n\n                const descFragment = document.createDocumentFragment();\n                let details;\n\n                if (character.isProtagonist) {\n                    details = [\n                        { label: 'æ€§åˆ«/å¹´é¾„', value: character.info[character.infoHeaders.indexOf('æ€§åˆ«/å¹´é¾„')] }, \n                        { label: 'å¤–è²Œ', value: character.info[character.infoHeaders.indexOf('å¤–è²Œç‰¹å¾')] }, \n                        { label: 'èŒä¸š/èº«ä»½', value: character.info[character.infoHeaders.indexOf('èŒä¸š/èº«ä»½')] },\n                        { label: 'æ€§æ ¼', value: character.info[character.infoHeaders.indexOf('æ€§æ ¼ç‰¹ç‚¹')] },\n                        { label: 'è¿‡å¾€ç»å†', value: character.info[character.infoHeaders.indexOf('è¿‡å¾€ç»å†')] }\n                    ];\n                } else {\n                    details = [\n                        { label: 'æ€§åˆ«/å¹´é¾„', value: character.info[character.infoHeaders.indexOf('æ€§åˆ«/å¹´é¾„')] }, \n                        { label: 'å¤–è²Œ', value: character.info[character.infoHeaders.indexOf('å¤–è²Œç‰¹å¾')] }, \n                        { label: 'æ€§æ ¼', value: character.info[character.infoHeaders.indexOf('æ€§æ ¼ç‰¹ç‚¹')] },\n                        { label: 'æŒæœ‰ç‰©å“', value: character.info[character.infoHeaders.indexOf('æŒæœ‰çš„é‡è¦ç‰©å“')] },\n                        { label: 'å¥½æ„Ÿåº¦', value: character.info[character.infoHeaders.indexOf('å¥½æ„Ÿåº¦')] },\n                        { label: 'è¿‡å¾€ç»å†', value: character.info[character.infoHeaders.indexOf('è¿‡å¾€ç»å†')] }\n                    ];\n                }\n\n                details.forEach(detail => {\n                    if (detail.value !== null && detail.value !== undefined) {\n                        const p = document.createElement('p');\n                        const value = typeof detail.value === 'string' ? detail.value.replace(/\\n/g, '<br>') : detail.value;\n                        p.innerHTML = `<strong>${detail.label}:</strong> ${value}`;\n                        descFragment.appendChild(p);\n                    }\n                });\n                contentContainer.appendChild(descFragment);\n\n                const interactFragment = document.createDocumentFragment();\n                if (character.isProtagonist) {\n                    const interactionHeaders = [\"é€‰é¡¹ä¸€\", \"é€‰é¡¹äºŒ\", \"é€‰é¡¹ä¸‰\", \"é€‰é¡¹å››\"];\n                    interactionHeaders.forEach(header => {\n                        const interactionText = character.info[character.infoHeaders.indexOf(header)];\n                        if (interactionText) {\n                            const button = document.createElement('button');\n                            button.className = 'function-btn interaction-button';\n                            button.textContent = interactionText;\n                            button.onclick = () => {\n                                sendGameActionRequest(interactionText);\n                                closeModal('character-modal');\n                            };\n                            interactFragment.appendChild(button);\n                        }\n                    });\n                }\n                \n                if (interactFragment.hasChildNodes()) {\n                    interactionsContainer.appendChild(interactFragment);\n                    interactionsContainer.style.display = 'grid';\n                } else {\n                    interactionsContainer.innerHTML = ''; // For non-protagonists, clear it\n                    interactionsContainer.style.display = 'none';\n                }\n\n                openModal('character-modal');\n            }\n            \n            function setupModalContent(modalId, containerId, tableData, createItemElement) {\n                const container = document.getElementById(containerId);\n                container.innerHTML = '';\n                if (!tableData || !tableData.rows || tableData.rows.length === 0) {\n                    container.innerHTML = '<p style=\"text-align:center;\">æš‚æ— å†…å®¹</p>';\n                    return;\n                }\n                const list = document.createElement('ul');\n                list.className = 'item-list';\n                tableData.rows.forEach(row => {\n                    const listItem = createItemElement(row, tableData.headers);\n                    list.appendChild(listItem);\n                });\n                container.appendChild(list);\n            }\n\n            function sendGameActionRequest(msg) {\n                console.log(\"Action sent:\", msg);\n                if (typeof parent.triggerSlash === 'function') {\n                    try {\n                        parent.triggerSlash('/setinput ' + msg);\n                    } catch(e) {\n                        alert(e.toString());\n                    }\n                } else {\n                    const input = parent.document.getElementById('send_textarea');\n                    if (input) {\n                        input.value = msg;\n                    } else {\n                        alert('é”™è¯¯: æ— æ³•æ‰¾åˆ°è¾“å…¥æ¡†ã€‚');\n                    }\n                }\n            }\n            \n            // Initial Load\n            const initialData = getTableData();\n            const tables = processJsonData(initialData);\n            renderUI(tables);\n            \n            // Register update callback\n            dataSourceAPI.registerTableUpdateCallback(function(newData) {\n                console.log(\"Received data update, refreshing UI...\");\n                const updatedTables = processJsonData(newData);\n                renderUI(updatedTables);\n            });\n\n            // Bind button events\n            document.getElementById('skill-button').onclick = () => openModal('skill-modal');\n            document.getElementById('inventory-button').onclick = () => openModal('inventory-modal');\n            document.getElementById('quest-button').onclick = () => openModal('quest-modal');\n            // document.getElementById('shop-button').onclick = () => openModal('shop-modal');\n\n            // Re-bind close for protagonist/character modal specifically, as it might be recreated\n            const charModal = document.getElementById('character-modal');\n            if(charModal){\n                charModal.querySelector('.close-modal-button').onclick = () => closeModal('character-modal');\n            }\n\n\n            // Map pan and zoom logic\n            const svg = document.getElementById('visual-map');\n            let viewBox = { x: 0, y: 0, w: 800, h: 600 };\n            let isPanning = false;\n            let startPoint = { x: 0, y: 0 };\n            \n            function updateViewBox() {\n                const vb = svg.getAttribute('viewBox').split(' ').map(Number);\n                viewBox = { x: vb[0], y: vb[1], w: vb[2], h: vb[3] };\n                svg.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.w} ${viewBox.h}`);\n            }\n\n            document.getElementById('zoom-in-btn').addEventListener('click', () => {\n                const vb = svg.getAttribute('viewBox').split(' ').map(Number);\n                viewBox = { x: vb[0], y: vb[1], w: vb[2], h: vb[3] };\n                const newW = viewBox.w * 0.9;\n                const newH = viewBox.h * 0.9;\n                viewBox.x += (viewBox.w - newW) / 2;\n                viewBox.y += (viewBox.h - newH) / 2;\n                viewBox.w = newW;\n                viewBox.h = newH;\n                svg.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.w} ${viewBox.h}`);\n            });\n\n            document.getElementById('zoom-out-btn').addEventListener('click', () => {\n                const vb = svg.getAttribute('viewBox').split(' ').map(Number);\n                viewBox = { x: vb[0], y: vb[1], w: vb[2], h: vb[3] };\n                const newW = viewBox.w * 1.1;\n                const newH = viewBox.h * 1.1;\n                viewBox.x += (viewBox.w - newW) / 2;\n                viewBox.y += (viewBox.h - newH) / 2;\n                viewBox.w = newW;\n                viewBox.h = newH;\n                svg.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.w} ${viewBox.h}`);\n            });\n            \n            svg.addEventListener('mousedown', (e) => {\n                if (e.buttons !== 1) return; // Only pan on left click\n                isPanning = true;\n                startPoint = { x: e.clientX, y: e.clientY };\n                svg.style.cursor = 'grabbing';\n            });\n             svg.addEventListener('mousemove', (e) => {\n                if (!isPanning) return;\n                const vb = svg.getAttribute('viewBox').split(' ').map(Number);\n                viewBox = { x: vb[0], y: vb[1], w: vb[2], h: vb[3] };\n                const endPoint = { x: e.clientX, y: e.clientY };\n                const dx = (startPoint.x - endPoint.x) * (viewBox.w / svg.clientWidth);\n                const dy = (startPoint.y - endPoint.y) * (viewBox.h / svg.clientHeight);\n                viewBox.x += dx;\n                viewBox.y += dy;\n                svg.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.w} ${viewBox.h}`);\n                startPoint = endPoint;\n            });\n            const stopPanning = () => {\n                isPanning = false;\n                svg.style.cursor = 'grab';\n            };\n            svg.addEventListener('mouseup', stopPanning);\n            svg.addEventListener('mouseleave', stopPanning);\n\n            // Bind close buttons for all modals\n            document.querySelectorAll('.modal-overlay').forEach(modal => {\n                modal.querySelector('.close-modal-button').onclick = () => modal.classList.remove('visible');\n                // Also close on overlay click\n                modal.addEventListener('click', function(event) {\n                    if (event.target === this) {\n                        this.classList.remove('visible');\n                    }\n                });\n            });\n        });\n    </script>\n</body>\n</html>\n\n```\n",
    "trimStrings": [],
    "placement": [
        2
    ],
    "disabled": false,
    "markdownOnly": true,
    "promptOnly": false,
    "runOnEdit": true,
    "substituteRegex": 0,
    "minDepth": null,
    "maxDepth": 2
}